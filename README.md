# Prerequisites
* Quartus 20.4+
* python 3

# Compile the DOGPU specialized compiler
* `cd <DOGPU_HOME>/scripts`
* `./download_and_compile_llvm.sh`

# Compile DOGPU kernel
* `cd <DOGPU_HOME>/kernels`
* `./compile_and_log.sh dl_fir5_fp32.cpp`
* binary and objdump will be generated in directory *compiler_outputs*
	* binary: cram.mif
	* objdump: dl_fir5_fp32.objdump

# Run RTL simulation with ideal HBM model
## Create DOGPU executable
* **Currently DOGPU compiler does not support VLIW mode, generated binary is manually transformed to VLIW mode**
* `cd <DOGPU_HOME>/RTL/sim/fir`
* *dl_fir5_fp32.objdump* is the original objdump generated by the compiler. *dl_fir5_fp32_vliw.objdump* is the objdump transformed to VLIW mode. *cram_vliw.mif* is the transformed executable
* Each VLIW instruction is 64 bit wide, with low 32-bit sub-instruction targeting scalar function unit, high 32-bit subinstruction targeting macro function unit. A sub-instruction must be filled with *zeros* if it's a *NOP*

## Create DOGPU kernel configuration
* `cd <DOGPU_HOME>/RTL/sim/fir`
* *krnl_ram.mif* is the example kernel configuration file
### Kernel configuration format
+------------+-------------------------------------------------------------+
|            |                          Bit fields                         |
+------------+---------+-------+-------+-------+---------+-----------------+
| Word Index |  31:30  | 29:28 | 27:20 | 19:14 |  13:10  |       9:0       |
+------------+---------+-------+-------+-------+---------+-----------------+
|      0     |   #WF-1 in WG   |       -       | Instruction start address |
+------------+-----------------+---------------+---------------------------+
|      1     |                      Global size in D0                      |
+------------+-------------------------------------------------------------+
|      2     |                      Global size in D1                      |
+------------+-------------------------------------------------------------+
|      3     |                      Global size in D2                      |
+------------+-------------------------------------------------------------+
|      4     |                     Global offset in D0                     |
+------------+-------------------------------------------------------------+
|      5     |                     Global offset in D1                     |
+------------+-------------------------------------------------------------+
|      6     |                     Global offset in D2                     |
+------------+---------+---------------+-----------------+-----------------+
|      7     | #dins-1 | WG size in D2 |  WG size in D1  |  WG size in D0  |
+------------+---------+---------------+-----------------+-----------------+
|      8     |                         #WG-1 in D0                         |
+------------+-------------------------------------------------------------+
|      9     |                         #WG-1 in D1                         |
+------------+-------------------------------------------------------------+
|     10     |                         #WG-1 in D2                         |
+------------+-----------------+-------------------------+-----------------+
|     11     |   #Parameters   |                         |  #threads in WG |
+------------+-----------------+-------------------------+-----------------+
|    12-15   |                              -                              |
+------------+-------------------------------------------------------------+
|    16-31   |                          Parameters                         |
+------------+-------------------------------------------------------------+

## Generate memory initialization file
* `cd <DOGPU_HOME>/RTL`
* `./gen_mem_init.py count_float`

## Generate modelsim simulation script
* Open Quartus
* `cd <DOGPU_HOME>/project_quartus`
* `quartus &`
* Open project "FGPU.qpf"
* Assignments -> IP Settings
	* "IP generation HDL preference": select "VHDL"
	* Check "Generate IP simulation model when generating IP"
* Run "IP Generation"
* Tools -> Generate Simulator Setup Script for IP -> OK

## Run RTL simulation
* `cd <DOGPU_HOME>/project_quartus`
* Open *test.sh* with any editor
* Point `QSYS_SIMDIR` to your `project_quartus` path
* `source test.sh`
### Compare results
* Memory content after DOGPU execution will be generated in *./RTL/result_mem.mif*
* `cd <DOGPU_HOME>/RTL`
* `./compare_fir_res.py`

